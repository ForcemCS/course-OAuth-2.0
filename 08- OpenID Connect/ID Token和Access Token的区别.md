## ID Token和Access Token的区别

`Access Token`和`ID Token`服务于**完全不同的目的**，拥有**完全不同的受众（Audience）**，并且应用（Client）对待它们的**方式也必须完全不同**。

#### 一个常见的困惑点

- 很多现代的授权服务器，为了方便，会同时使用**JWT (JSON Web Token)** 格式来制作`Access Token`和`ID Token`。
- 因此，当你拿到这两个令牌时，它们看起来都是 `xxxxx.yyyyy.zzzzz` 这种三段式的字符串，解码后里面都有JSON数据，这让人觉得它们是类似的东西。

**这是一种错觉！即使格式相同，它们的内在含义和用途也截然不同。**

### Access Token：给“API”看的“门禁卡”

- **用途 (Purpose)**：
  - 它的**唯一用途**是用来**访问受保护的API（资源服务器）**。
  - 它代表的是**“授权” (Authorization)** —— 即“允许你做什么”。
- **受众 (Audience)**：
  - 它的**预期接收者和解释者**是**API（资源服务器）**。
  - 在JWT中，它的`aud` (audience) claim通常是API的唯一标识符（比如 `https://api.mygame.com`）。
- **应用（Client）应该如何对待它？**
  - **必须将其视为“不透明的” (Opaque)**。
  - 这意味着，你的**应用（Client）不应该、也绝不能**去尝试解码、读取或理解`Access Token`内部的内容。
  - 你的应用只需要做一件事：**像一个黑盒子一样，拿到它，保存它，然后在每次请求API时，原封不动地把它放到`Authorization`头里发送出去。**
  - **酒店房卡的比喻**：你从前台拿到房卡，你不会去关心房卡里的磁条记录了什么数据，你也不需要懂。你只需要知道，拿着它去刷门，门能开就行了。房卡是给“门锁”（API）看的，不是给你看的。
- **格式 (Format)**：
  - OAuth 2.0规范**没有规定**它的格式。它可以是JWT，也可以是任何随机字符串。你的应用不应该做任何关于其格式的假设。

### ID Token：给“应用”看的“身份证”

- **用途 (Purpose)**：
  - 它的**唯一用途**是向你的**应用（Client）\**证明\**用户的身份**。
  - 它代表的是**“认证” (Authentication)** —— 即“证明你是谁”。
- **受众 (Audience)**：
  - 它的**预期接收者和解释者**是**你的应用（Client）**。
  - 在JWT中，它的`aud` (audience) claim**必须**是你的应用的**`client_id`**。
- **应用（Client）应该如何对待它？**
  - **必须解码并验证它 (MUST be read by the application)**。
  - 你的应用在拿到`ID Token`后，必须执行以下操作：
    1. **验证签名**：用授权服务器的公钥来确认它没有被伪造。
    2. **验证声明 (Claims)**：检查`iss`（签发者）、`aud`（受众）、`exp`（有效期）等信息是否都符合预期。
    3. **读取信息**：从`sub`（用户ID）、`name`、`email`等声明中，安全地获取用户信息。
  - **护照的比喻**：`ID Token`就像是用户的护照。你的应用（比如航空公司柜台）拿到护照后，必须打开它，检查照片、姓名、有效期、防伪标识，以确认乘客的身份。护照是给你（柜台）看的。
- **格式 (Format)**：
  - OpenID Connect规范**严格规定**，它**必须是JWT**。

### 总结：一张表格看懂区别

| 特性                 | **Access Token (门禁卡)**                        | **ID Token (身份证)**                                 |
| -------------------- | ------------------------------------------------ | ----------------------------------------------------- |
| **目的**             | **授权 (Authorization)** - 访问API               | **认证 (Authentication)** - 识别用户                  |
| **受众 (Audience)**  | **API / 资源服务器**                             | **你的应用 / 客户端**                                 |
| **应用该如何对待？** | **不透明 (Opaque)** - 绝不解码，直接转发         | **必须解码和验证** - 检查签名和声明，读取用户信息     |
| **格式**             | **不确定** (可以是任何字符串，也可能是JWT)       | **必须是JWT**                                         |
| **核心信息**         | 包含了权限(`scope`)、用户ID等，**给API看的信息** | 包含了用户ID(`sub`)、姓名、邮箱等，**给应用看的信息** |

**一个常见的错误用法**：
一些开发者在拿到一个JWT格式的`Access Token`后，会错误地从中解析出用户信息（比如`sub`）来在前端显示。这是**严重违反OAuth设计原则**的。`Access Token`是给API的，应用不应该依赖它的内部结构。获取用户信息**唯一正确、标准的方式**是解码和验证`ID Token`。