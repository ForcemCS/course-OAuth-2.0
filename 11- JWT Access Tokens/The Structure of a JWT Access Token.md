## The Structure of a JWT Access Token

接下来将介绍**剖析JWT作为`Access Token`时的内部结构和标准化声明（Claims）**。学会如何“阅读”一张JWT格式的“通行证”，明白上面每一个字段的精确含义。

### 核心思想：为“门禁卡”制定一套行业标准

我们之前知道，`Access Token`可以是任何格式。但如果大家都用JWT，并且都遵循一套统一的规范来填写里面的内容，那么API开发者就能更容易地使用现成的工具库来验证它，整个生态系统会更健壮。

就是这个“行业标准”——**《JSON Web Token Profile for OAuth 2.0 Access Tokens》**。它规范了当`Access Token`是JWT时，里面应该包含哪些必需的和可选的声明（Claims）。

### JWT的本质

- **三段式结构**：Header.Payload.Signature
- **Base64编码**：前两部分是Base64编码的JSON。
- **签名而非加密**：JWT默认是**签名的**（防伪），而不是**加密的**（防窥）。所以Payload里的信息是公开可见的，不能放真正的秘密。

### 标准化的JWT `Access Token`声明 (Claims)

这些是API在验证时**必须**检查的字段。

- **`iss` (Issuer - 签发者)**
  - **含义**：这个令牌是由谁签发的。通常是授权服务器的基础URL。
  - **API的职责**：必须验证`iss`是否是自己信任的那个授权服务器。
- **`exp` (Expiration Time - 过期时间)**
  - **含义**：一个Unix时间戳，令牌在此之后失效。
  - **API的职责**：必须检查当前时间是否已经超过了`exp`。这个字段是**强制性**的，意味着JWT格式的`Access Token`不能是永久有效的。
- **`iat` (Issued At - 签发时间)**
  - **含义**：一个Unix时间戳，令牌是何时创建的。
  - **API的职责**：可以用来辅助判断令牌的新鲜度。
- **`aud` (Audience - 受众)**
  - **含义**：这个令牌是给谁用的。**必须**是你的API（资源服务器）的唯一标识符。
  - **API的职责**：必须验证`aud`是否等于自己的Identifier。这是防止令牌被滥用于其他API的关键。
- **`sub` (Subject - 主题)**
  - **含义**：这个令牌**代表谁**。
  - **如果是用户流程**：`sub`就是用户的唯一ID。
  - **如果是M2M流程（客户端凭证）**：`sub`就应该是发起请求的那个客户端应用的`client_id`。
  - **API的职责**：用它来识别请求的来源主体。
- **`client_id`**
  - **含义**：明确指出这个令牌是颁发给了哪个**客户端应用**。
  - **API的职责**：可以用它来做更精细的控制，比如记录是哪个应用发起的请求，或者对不同的应用采取不同的策略。
- **`jti` (JWT ID)**
  - **含义**：这个JWT令牌本身的唯一ID。
  - **API的职责**：可以用来防止令牌重放攻击。API可以记录下已经处理过的`jti`，如果再次看到同一个`jti`，就拒绝它。

#### 可选的声明 (Optional Claims)

这些声明提供了更丰富的上下文信息，API可以根据自己的业务需求来使用它们。

- **`scope`**
  - **含义**：一个字符串，用空格分隔，列出了这个令牌被授予的权限范围。比如`"read:logs write:servers"`。
  - **API的职责**：在验证完令牌的基本有效性后，**必须**检查`scope`，以确定这个令牌是否有权限执行当前请求的操作。
- **`auth_time` (Authentication Time - 用户认证时间)**
  - **含义**：用户**上一次**在授权服务器进行强认证（如输入密码）的时间戳。
  - **API的职责**：可以用于实现“步进式认证 (Step-up Authentication)”。比如，一个普通的API请求可以接受这个令牌。但如果要执行一个高风险操作（如删除服务器），API可以检查`auth_time`是否在最近的5分钟内。如果不是，就拒绝请求，并提示客户端需要引导用户去重新认证。
- **`acr` (Authentication Context Class Reference)** 和 **`amr` (Authentication Methods Reference)**
  - 这两个声明来自OIDC，提供了关于**认证上下文和方法**的详细信息。
  - **`acr`**：认证的“等级”。比如`"0"`可能代表只是基于之前的会话登录，没有输入密码；`"1"`可能代表输入了密码。API可以要求高风险操作必须由`acr`等级更高的令牌来执行。
  - **`amr`**：一个数组，列出了用户本次认证所使用的具体方法。比如`["pwd", "mfa"]`表示用户既输入了密码，又通过了多因素认证。`["fpt"]`可能代表指纹。API可以根据这个列表来判断认证的强度。

- **自定义声明 (Custom Claims)**
  - 授权服务器完全可以在令牌中加入自己定义的任何信息，比如用户的**用户组 (`groups`)**、**姓名 (`name`)**、**邮箱 (`email`)**等。
  - **API的职责**：可以利用这些自定义声明来简化授权逻辑。比如，可以直接从令牌中读取用户所属的用户组，而无需再去数据库查询。