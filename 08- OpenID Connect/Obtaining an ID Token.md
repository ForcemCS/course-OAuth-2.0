## Obtaining an ID Token

**作为应用开发者，如何才能获取到`ID Token`**。

### 核心思想：获取“身份证” (`ID Token`) 的方式不止一种，但有一种方式远比其他方式更安全。

你的应用（Client）通常既需要`Access Token`（去访问API），也需要`ID Token`（来识别用户）。那么如何同时拿到这两样东西呢？

### 方案一：在授权码流程中“顺便”获取 (推荐的最佳实践)

这是**最简单、最安全、最推荐**的方法。

- **如何操作？**

  1. 你使用标准的**授权码流程 (Authorization Code Flow)**，也就是我们之前详细拆解的那个流程（带PKCE）。

  2. 在构建最初的`Authorization URL`时，你在`scope`参数里，除了添加你需要的API权限（如`photos`），再**额外加上一个特殊的scope**：**`openid`**。

     > `...&scope=openid%20photos&...`

  3. **`openid`这个scope就像一个神奇的开关**。它告诉授权服务器：“嘿，我不仅要走OAuth 2.0的流程拿`Access Token`，我还想启用OpenID Connect的功能，请在最后也给我一个`ID Token`。”

- **结果是什么？**

  - 整个流程和之前完全一样：用户登录 -> 你拿到`code` -> 你用`code`去后台换令牌。

  - 唯一的区别是，在最后的后通道令牌交换中，授权服务器返回的JSON响应里，会多出一个`id_token`字段。

    ```json
    {
      "access_token": "...",
      "expires_in": 3600,
      "id_token": "a_long_jwt_string_for_the_id_token",
      "token_type": "Bearer"
    }
    ```

### 方案二：使用“隐式流程”直接获取 (不推荐)

这种方式在某些特定场景下（比如你只需要认证用户，完全不需要访问任何API）可能会被提到，但它有显著的安全风险。

- **如何操作？**

  1. 在构建`Authorization URL`时，你将`response_type`参数的值从`code`改为`id_token`

     > `...&response_type=id_token&...`

  2. 这个`response_type`告诉授权服务器：“我**只想要**一个`ID Token`，我不需要`Access Token`，也不需要经过`code`这个中间步骤。”

- **结果是什么？**

  - 用户在授权服务器登录并同意后，授权服务器会**直接在重定向URL的片段（`#`）中，把完整的`ID Token`返回给你的应用**。
  - 这个流程看起来非常像OAuth 2.0中那个**不被推荐的“隐式流程 (Implicit Flow)”**。

- **这种方式的风险与挑战**：

  1. **令牌通过不安全的前通道传输**：`ID Token`（可能包含用户的姓名、邮箱等个人身份信息PII）直接暴露在浏览器的地址栏中，有被窃听、截获的风险。
  2. 必须进行严格验证：因为`ID Token`是从一个不可信的前通道“飞过来”的，你的应用必须、必须、必须对它进行完整的、严格的验证：
     - 验证签名，确认它没被篡改且来自正确的签发者。
     - 验证`iss`, `aud`, `exp`, `nonce`等所有声明，确保它是颁发给你这个应用、针对本次请求的、且未过期的。
  3. **授权服务器无法确认送达**：服务器把`ID Token`“扔”出去后，它完全不知道客户端是否成功收到了，流程是否成功了。

### 如何在ID Token中获取更多用户信息？

- **仅使用`scope=openid`**：你得到的`ID Token`中，通常只会包含最基本的元数据和`sub`声明。
- **添加更多OIDC标准Scope**：
  - **`scope=profile`**: 请求用户的基本个人资料（如姓名`name`、昵称`nickname`、头像`picture`等）。
  - **`scope=email`**: 请求用户的邮箱地址`email`。
  - **`scope=address`**: 请求用户的地址信息。
  - **`scope=phone`**: 请求用户的电话号码。
- **一个重要的注意事项**：
  - 不同的授权服务器实现不同。有些服务器会把所有你请求的个人信息都直接打包进`ID Token`里。
  - 而另一些服务器，为了让`ID Token`保持简洁，可能只在里面放`sub`，然后要求你用拿到的`Access Token`去调用一个专门的**`/userinfo`端点**，才能获取到完整的个人资料。
  - **你需要查阅你所使用的授权服务器的文档**，来确定它的具体行为。