## Limitations of IoT and Smarthome Devices

接下来介绍一个非常特殊但越来越常见的场景：**如何让那些没有键盘或没有浏览器的设备（如智能电视、物联网设备）安全地获取OAuth令牌。**

完全不同的OAuth流程——**设备授权流程 (Device Authorization Flow)**。

### 核心思想：将“输入设备”与“目标设备”分离

传统OAuth流程（如授权码流程）有两个基本假设：

1. 设备上**有浏览器**（或能启动一个浏览器视图）。
2. 设备上**有键盘**（或便捷的输入方式）来输入用户名和密码。

大量的现代设备**不满足**这两个条件：

- 智能电视 (Smart TVs)：
  - 可能有简陋的浏览器，但没有物理键盘。
  - 使用遥控器在屏幕上一个一个选择字母来输入密码，是一种**极其痛苦、缓慢且不安全**的体验（旁边的人可以清楚地看到你输入的密码）。
- 物联网设备 (IoT Devices)：
  - 比如一个硬件视频编码器，可能只有一个小摇杆和几个按钮，输入密码几乎是不可能完成的任务。
- 语音助手 (Voice Assistants)：
  - 比如Amazon Alexa或Google Home。你总不能**大声地把你的密码念出来**吧？这完全不合理。

这些设备依然需要访问受保护的API（比如，智能电视上的Netflix应用需要登录你的Netflix账户），但传统的OAuth流程在它们身上根本行不通。

### 解决方案：设备授权流程 (Device Authorization Flow)

这个流程的精髓在于一个巧妙的**“解耦”**思想：

> **我们把“需要登录和授权”这个复杂的任务，从那个能力有限的“目标设备”（如电视）上，转移到一个你手边功能强大的“输入设备”（如你的手机或电脑）上来完成。**

你肯定见过这个流程，即使不知道它的名字。

**典型的用户体验：**

1. 你在你的Apple TV上打开一个新的视频应用，点击“登录”。
2. 电视屏幕上**不会**出现一个让你用遥控器输密码的界面。
3. 相反，屏幕上会显示一个简单的指示（如下图）：
   - **“请在您的手机或电脑上访问：`somesite.com/activate`”**
   - **“并输入以下代码：`ABCD-EFGH`”**
4. 你拿出**手机**，打开浏览器，访问那个URL，输入屏幕上的代码。
5. 你的**手机浏览器**会跳转到该应用的正常登录页面。你在手机上用你熟悉的键盘轻松地输入用户名和密码，完成登录和授权。
6. 手机上显示“成功！您的电视现已登录。”
7. 与此同时，你电视上的应用界面会自动刷新，显示你已经登录成功了。

### 这个流程是如何在后台工作的？（高层概览）

这个流程的神奇之处在于，**你的手机和电视之间不需要任何直接的通信**（比如蓝牙或在同一个Wi-Fi下）。它们之间的所有协调工作都是通过**授权服务器**这个“中间人”来完成的。

1. **电视发起请求**：
   - 当你在电视上点击“登录”时，电视应用在后台向授权服务器发起一个请求：“我是一个无键盘无浏览器的设备，我想启动一次设备授权流程。”
2. **服务器返回指令**：
   - 授权服务器返回一组指令给电视，包括：
     - 一个给用户看的**用户码 (user_code)**，比如 `ABCD-EFGH`。
     - 一个给用户看的**验证URL (verification_uri)**，比如 `somesite.com/activate`。
     - 一个只有电视自己知道的**设备码 (device_code)**，这是它后续用来轮询的凭证。
     - 一个轮询间隔时间（比如5秒）。
3. **电视显示指令并开始轮询 (Polling)**：
   - 电视把`user_code`和`verification_uri`显示在屏幕上。
   - 然后，它开始一个**循环**：每隔5秒，就用`device_code`去问授权服务器：“那个用户在手机上弄完了吗？我能拿令牌了吗？”
4. **用户在手机上操作**：
   - 你拿出手机，访问那个URL，输入`user_code`。
   - 授权服务器知道你现在要为哪个设备（由`user_code`标识）进行授权了。
   - 你在手机上完成了整个登录和同意流程。
5. **授权完成，电视获取令牌**：
   - 当你在手机上点击“同意”后，授权服务器就在后台标记：“`ABCD-EFGH`这个流程已经完成了！”
   - 下一次，当电视再次来轮询时，授权服务器的回答就变成了：“他弄完了！这是给你的`access_token`！”
   - 电视拿到令牌，登录成功。

### 总结

- **设备授权流程**是专门为**无键盘/无浏览器**的设备设计的OAuth扩展。
- 它的核心是**将认证行为从目标设备转移到用户随身携带的、功能齐全的设备（如手机）上**。
- 它通过**授权服务器**作为中介，利用**轮询 (Polling)** 机制来协调两个设备之间的状态。
- **并非所有**OAuth服务器都支持这个流程，开发者在使用前需要确认。
- 这是一个非常优雅的解决方案，极大地改善了在这些受限设备上的用户登录体验。