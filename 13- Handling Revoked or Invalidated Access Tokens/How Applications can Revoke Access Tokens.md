## How Applications can Revoke Access Tokens

**令牌失效的最后一种情况：由应用（Client）主动发起的令牌撤销**。

### 核心思想：应用可以“好心地”通知授权服务器，它不再需要某个令牌了

之前的令牌撤销，都是由**授权服务器**或**用户**发起的（比如管理员禁用账户、用户修改密码、用户在设置里撤销授权等）。这些都是应用**被动**接收的结果。

接下来介绍的是一种**主动**的行为：**应用自己去请求撤销令牌。**

### 为什么应用需要主动撤销令牌？

最主要、最常见的场景就是**用户登出 (Log Out)**。

- **登出的真正含义**：当用户在应用中点击“登出”按钮时，用户的意图是**“终止我当前在这个应用上的所有会话，让我回到未登录状态”**。
- 如果不主动撤销会发生什么？
  - 应用只是在本地清除了存储的`access_token`和`refresh_token`（比如从内存或钥匙串中删除）。
  - 但是，这些令牌在授权服务器那边**依然是有效的**！
  - 如果这些令牌在被清除之前，因为某种原因（如XSS、设备被盗）已经泄露了，那么攻击者依然可以在它们的有效期内继续使用它们。
- 主动撤销的好处：
  - 应用在本地清除令牌的**同时**，还向授权服务器发送一个请求：“嘿，我代表的用户要登出了，请把我手上这张令牌（以及和它相关的所有令牌）都立即作废。”
  - 这是一种**“清理门户”**的行为，确保了即使用户登出后令牌被泄露，它也已经是一张废卡了。
  - 这大大提升了系统的安全性，是一种负责任的、良好的开发实践。

### 如何实现主动撤销？

OAuth 2.0为此定义了一个专门的端点和流程，标准化在 **RFC 7009: OAuth 2.0 Token Revocation** 中。

1. **找到撤销端点 (Revocation Endpoint)**：
   - 应用需要知道授权服务器的“令牌撤销服务窗口”地址。这个地址通常也在服务器的元数据URL中可以找到。
2. **应用发起POST请求**：
   - 当用户点击登出时，应用在清除本地令牌之前，向这个撤销端点发起一个**安全的后通道POST请求**。
   - 请求体内容：
     - `token={THE_TOKEN_TO_REVOKE}`: 想要撤销的令牌字符串（可以是`access_token`或`refresh_token`）。
     - `token_type_hint` (可选): 可以告诉服务器这个令牌的类型是`access_token`还是`refresh_token`，以帮助服务器更快地查找。
   - **请求需要身份验证**：与令牌内省一样，撤销端点也是受保护的。应用在调用它时，**必须证明自己的身份**（通常使用`client_id`和`client_secret`进行Basic Auth）。
3. **授权服务器的响应**：
   - 授权服务器收到请求，验证应用的身份。
   - 它在自己的数据库中找到这个令牌，并将其标记为“已撤销”。
   - 通常，它会返回一个`200 OK`的空响应，表示操作成功。

### 撤销的“连锁反应”

当撤销一个令牌时，授权服务器的行为是怎样的？

- **撤销`Refresh Token`**：
  - 这通常是一个**“斩草除根”**的操作。
  - 授权服务器在撤销一个`refresh_token`时，**几乎总会**将其关联的所有`access_token`（即由这个`refresh_token`派生出来的所有访问令牌）也一并撤销。
- **撤销`Access Token`**：
  - 当只请求撤销一个`access_token`时，是否要同时撤销其对应的`refresh_token`，这取决于**授权服务器的策略**。
  - 有些服务器可能会这样做，有些则不会。你需要查阅你所使用的授权服务器的文档来确定其具体行为。

### 局限性与总结

- 这是一个“君子协定”：
  - 授权服务器**无法强制**要求应用在用户登出时必须调用撤销端点。
  - 这是一个**应用自愿执行**的“好习惯”。
  - 应用也可能因为各种原因（如用户直接卸载App）而无法调用撤销端点。
- 服务器不能依赖它：
  - 正因为如此，授权服务器**不能**依赖应用的“主动撤销”来作为唯一的令牌清理机制。
  - 它**仍然必须**有自己的一套令牌**过期策略**（`expires_in`）作为最终的保障。

**对API开发者的影响**：

- 对API来说，一个被应用主动撤销的令牌，和一个因为其他原因（如用户被禁用）而被撤销的令牌，在验证时**看起来是完全一样的**。
- 无论哪种情况，当API去进行**远程令牌内省**时，都会得到`"active": false`的结果。

**总结一下**：

1. **令牌撤销端点**是OAuth提供给**应用（Client）**的一个工具，让它可以在用户登出等场景下，**主动、即时地**使其持有的令牌失效。
2. 这是一个**提升安全性的最佳实践**，但不是一个可以强制执行的规则。
3. 作为应用开发者，在实现登出功能时，应该养成“**本地清除 + 远程撤销**”的好习惯。